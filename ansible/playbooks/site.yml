---
# Main playbook for WordPress deployment
- name: Deploy WordPress on EC2 instance
  hosts: wordpress
  become: yes
  gather_facts: yes
  vars:
    mysql_root_password: "{{ vault_mysql_root_password | default('changeme123!') }}"
    mysql_wordpress_password: "{{ vault_mysql_wordpress_password | default('wordpress123!') }}"
    wordpress_db_name: "wordpress"
    wordpress_db_user: "wordpress"
    wordpress_title: "My WordPress Site"
    wordpress_admin_user: "admin"
    wordpress_admin_password: "{{ vault_wordpress_admin_password | default('admin123!') }}"
    wordpress_admin_email: "admin@example.com"
    
  pre_tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      
    - name: Wait for system to be ready
      wait_for_connection:
        connect_timeout: 20
        sleep: 5
        delay: 5
        timeout: 300

  roles:
    - system-prep
    - common
    - mysql
    - apache
    - php
    - wordpress
    
  post_tasks:
    - name: Final WordPress site information
      debug:
        msg: 
          - "ğŸ‰ WORDPRESS DEPLOYMENT SUCCESSFUL!"
          - "=================================="
          - ""
          - "ğŸŒ Your WordPress site is live at:"
          - "   ğŸ–¥ï¸  Frontend: http://{{ ansible_default_ipv4.address }}"
          - "   ğŸ”§ Admin Panel: http://{{ ansible_default_ipv4.address }}/wp-admin"
          - ""
          - "ğŸ” Admin Login Details:"
          - "   ğŸ‘¤ Username: {{ wordpress_admin_user }}"
          - "   ğŸ”‘ Password: {{ wordpress_admin_password }}"
          - "   ğŸ“§ Email: {{ wordpress_admin_email }}"
          - ""
          - "ğŸ“Š Your Server Details:"
          - "   ğŸ–¥ï¸  IP Address: {{ ansible_default_ipv4.address }}"
          - "   ğŸ’¾ Database: {{ wordpress_db_name }}"
          - "   ğŸ‘¥ DB User: {{ wordpress_db_user }}"
          - "   ğŸ§ OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - ""
          - "âš ï¸  IMPORTANT SECURITY STEPS:"
          - "   1. ğŸ” Change admin password immediately!"
          - "   2. ğŸ”„ Keep WordPress updated"
          - "   3. ğŸ›¡ï¸  Install security plugins"
          - ""
          - "ğŸš€ Next Steps:"
          - "   â€¢ Visit your site: http://{{ ansible_default_ipv4.address }}"
          - "   â€¢ Login to admin: http://{{ ansible_default_ipv4.address }}/wp-admin"
          - "   â€¢ Choose a theme and start customizing!"
          - ""
          - "âœ… Deployment Complete - Enjoy your WordPress site!"

    - name: Save site details to file
      copy:
        content: |
          WordPress Site Information
          ==========================
          
          Site URL: http://{{ ansible_default_ipv4.address }}
          Admin URL: http://{{ ansible_default_ipv4.address }}/wp-admin
          
          Login Credentials:
          Username: {{ wordpress_admin_user }}
          Password: {{ wordpress_admin_password }}
          Email: {{ wordpress_admin_email }}
          
          Database Details:
          Database: {{ wordpress_db_name }}
          DB User: {{ wordpress_db_user }}
          
          Server Information:
          IP Address: {{ ansible_default_ipv4.address }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          
          Generated on: {{ ansible_date_time.iso8601 }}
        dest: /tmp/wordpress-site-info.txt
        mode: '0600'
      delegate_to: localhost

    - name: Display saved information location
      debug:
        msg: "ğŸ“‹ Site details saved to: /tmp/wordpress-site-info.txt"
