---
# WordPress installation and configuration
- name: Download WordPress
  get_url:
    url: https://wordpress.org/latest.tar.gz
    dest: /tmp/wordpress.tar.gz
    mode: '0644'

- name: Extract WordPress
  unarchive:
    src: /tmp/wordpress.tar.gz
    dest: /tmp/
    remote_src: yes

- name: Copy WordPress files to web root
  copy:
    src: /tmp/wordpress/
    dest: /var/www/html/
    owner: www-data
    group: www-data
    mode: '0755'
    remote_src: yes

- name: Create WordPress configuration
  template:
    src: wp-config.php.j2
    dest: /var/www/html/wp-config.php
    owner: www-data
    group: www-data
    mode: '0644'

- name: Set WordPress directory permissions
  file:
    path: /var/www/html
    owner: www-data
    group: www-data
    mode: '0755'
    recurse: yes

- name: Create WordPress uploads directory
  file:
    path: /var/www/html/wp-content/uploads
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'

- name: Remove default index.html
  file:
    path: /var/www/html/index.html
    state: absent

- name: Check if WordPress is already installed
  uri:
    url: "http://{{ ansible_default_ipv4.address }}/wp-admin/install.php"
    method: GET
    status_code: [200, 302]
  register: wp_install_check
  ignore_errors: yes

- name: Install WordPress via WP-CLI
  block:
    - name: Download WP-CLI
      get_url:
        url: https://raw.githubusercontent.com/wp-cli/wp-cli/master/bin/wp
        dest: /usr/local/bin/wp
        mode: '0755'

    - name: Install WordPress core
      command: >
        wp core install 
        --url="http://{{ ansible_default_ipv4.address }}"
        --title="{{ wordpress_title }}"
        --admin_user="{{ wordpress_admin_user }}"
        --admin_password="{{ wordpress_admin_password }}"
        --admin_email="{{ wordpress_admin_email }}"
        --allow-root
      args:
        chdir: /var/www/html
      become_user: www-data
      when: wp_install_check.status != 302

- name: Clean up temporary files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/wordpress.tar.gz
    - /tmp/wordpress

- name: Wait for WordPress to be ready
  uri:
    url: "http://{{ ansible_default_ipv4.address }}"
    method: GET
    status_code: [200, 302]
  register: wordpress_ready
  retries: 3
  delay: 5
  until: wordpress_ready.status in [200, 302]

- name: Display WordPress installation success
  debug:
    msg:
      - "🎉 WordPress Installation Completed Successfully!"
      - "=================================================="
      - ""
      - "🌐 Your WordPress site is now available at:"
      - "   Frontend: http://{{ ansible_default_ipv4.address }}"
      - "   Admin Panel: http://{{ ansible_default_ipv4.address }}/wp-admin"
      - ""
      - "🔐 WordPress Admin Credentials:"
      - "   Username: {{ wordpress_admin_user }}"
      - "   Password: {{ wordpress_admin_password }}"
      - "   Email: {{ wordpress_admin_email }}"
      - ""
      - "📊 System Information:"
      - "   Server IP: {{ ansible_default_ipv4.address }}"
      - "   OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
      - "   PHP Version: {{ php_version | default('Detected during installation') }}"
      - "   MySQL Version: {{ mysql_verify.stdout | default('Latest available') }}"
      - ""
      - "⚠️  Security Reminders:"
      - "   1. Change the default admin password immediately!"
      - "   2. Keep WordPress core and plugins updated"
      - "   3. Consider enabling HTTPS with SSL certificate"
      - ""
      - "📝 Quick Links:"
      - "   - WordPress Dashboard: http://{{ ansible_default_ipv4.address }}/wp-admin"
      - "   - PHP Info: http://{{ ansible_default_ipv4.address }}/info.php"
      - "   - Install plugins: http://{{ ansible_default_ipv4.address }}/wp-admin/plugin-install.php"
      - ""
      - "✅ Installation Complete!"
