---
# WordPress installation and configuration
- name: Download WordPress
  get_url:
    url: https://wordpress.org/latest.tar.gz
    dest: /tmp/wordpress.tar.gz
    mode: '0644'

- name: Extract WordPress
  unarchive:
    src: /tmp/wordpress.tar.gz
    dest: /tmp/
    remote_src: yes

- name: Copy WordPress files to web root
  copy:
    src: /tmp/wordpress/
    dest: /var/www/html/
    owner: www-data
    group: www-data
    mode: '0755'
    remote_src: yes

- name: Create WordPress configuration
  template:
    src: wp-config.php.j2
    dest: /var/www/html/wp-config.php
    owner: www-data
    group: www-data
    mode: '0644'

- name: Set WordPress directory permissions
  file:
    path: /var/www/html
    owner: www-data
    group: www-data
    mode: '0755'
    recurse: yes

- name: Create WordPress uploads directory
  file:
    path: /var/www/html/wp-content/uploads
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'

- name: Remove default index.html
  file:
    path: /var/www/html/index.html
    state: absent

- name: Check if WordPress is already installed
  uri:
    url: "http://{{ ansible_default_ipv4.address }}/wp-admin/install.php"
    method: GET
    status_code: [200, 302]
  register: wp_install_check
  ignore_errors: yes

- name: Install WordPress via WP-CLI
  block:
    - name: Download WP-CLI
      get_url:
        url: https://raw.githubusercontent.com/wp-cli/wp-cli/master/bin/wp
        dest: /usr/local/bin/wp
        mode: '0755'

    - name: Install WordPress core
      command: >
        wp core install 
        --url="http://{{ ansible_default_ipv4.address }}"
        --title="{{ wordpress_title }}"
        --admin_user="{{ wordpress_admin_user }}"
        --admin_password="{{ wordpress_admin_password }}"
        --admin_email="{{ wordpress_admin_email }}"
        --allow-root
      args:
        chdir: /var/www/html
      become_user: www-data
      when: wp_install_check.status != 302

- name: Clean up temporary files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/wordpress.tar.gz
    - /tmp/wordpress
